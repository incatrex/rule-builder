{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://api.rulebuilder.com/schemas/rule-v1.0.7.json",
  "title": "Rule Builder Schema - v1.0.7",
  "description": "JSON Schema serving as single source of truth for validation and UI configuration",
  "version": "1.0.7",
  
  "type": "object",
  "required": ["structure", "returnType", "ruleType", "uuId", "version", "metadata", "content"],
  "properties": {
    "structure": { "type": "string", "enum": ["case", "condition", "expression"] },
    "returnType": { "type": "string", "enum": ["boolean", "number", "text", "date"] },
    "ruleType": { "type": "string", "enum": ["Reporting", "Transformation", "Aggregation", "Validation"] },
    "uuId": { "type": "string", "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$" },
    "version": { "type": "integer", "minimum": 1 },
    "metadata": {
      "type": "object",
      "required": ["id", "description"],
      "properties": {
        "id": { "type": "string" },
        "description": { "type": "string" }
      },
      "additionalProperties": false
    },
    "content": { "type": "object" }
  },
  "additionalProperties": false,

  "definitions": {
    "Expression": {
      "type": "object",
      "required": ["type", "returnType"],
      "properties": {
        "type": { "type": "string", "enum": ["value", "field", "function", "ruleRef"] },
        "returnType": { "type": "string", "enum": ["boolean", "number", "text", "date"] },
        "value": { "oneOf": [{ "type": "string" }, { "type": "number" }, { "type": "boolean" }, { "type": "null" }] },
        "field": { "type": "string" },
        "function": {
          "type": "object",
          "required": ["name", "args"],
          "properties": {
            "name": {
              "type": "string",
              "enum": ["MATH.ADD", "MATH.SUBTRACT", "MATH.MULTIPLY", "MATH.DIVIDE", "MATH.SUM", "MATH.ROUND", "MATH.ABS", "MATH.MAX", "TEXT.CONCAT", "TEXT.MID", "TEXT.LEN", "TEXT.CASE", "DATE.DIFF"]
            },
            "args": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["name", "value"],
                "properties": {
                  "name": { "type": "string" },
                  "value": { "$ref": "#/definitions/ExpressionGroup" }
                }
              }
            }
          }
        },
        "id": { "type": "string" },
        "uuid": { "type": "string" },
        "version": { "type": "integer" }
      }
    },

    "ExpressionGroup": {
      "type": "object",
      "required": ["type", "returnType", "expressions", "operators"],
      "properties": {
        "type": { "type": "string", "const": "expressionGroup" },
        "returnType": { "type": "string", "enum": ["boolean", "number", "text", "date"] },
        "expressions": {
          "type": "array",
          "minItems": 1,
          "items": { "oneOf": [{ "$ref": "#/definitions/Expression" }, { "$ref": "#/definitions/ExpressionGroup" }] }
        },
        "operators": {
          "type": "array",
          "items": { "type": "string", "enum": ["+", "-", "*", "/"] }
        }
      }
    },

    "ConditionGroup": {
      "type": "object",
      "required": ["type", "returnType", "name", "conjunction", "not", "conditions"],
      "properties": {
        "type": { "type": "string", "const": "conditionGroup" },
        "returnType": { "type": "string", "const": "boolean" },
        "name": { "type": "string" },
        "conjunction": { "type": "string", "enum": ["AND", "OR"] },
        "not": { "type": "boolean" },
        "conditions": {
          "type": "array",
          "items": { "oneOf": [{ "$ref": "#/definitions/Condition" }, { "$ref": "#/definitions/ConditionGroup" }] }
        }
      }
    },

    "Condition": {
      "type": "object",
      "required": ["type", "returnType", "name", "left", "operator", "right"],
      "properties": {
        "type": { "type": "string", "const": "condition" },
        "returnType": { "type": "string", "const": "boolean" },
        "name": { "type": "string" },
        "left": { "$ref": "#/definitions/ExpressionGroup" },
        "operator": {
          "type": "string",
          "enum": ["equal", "not_equal", "less", "less_or_equal", "greater", "greater_or_equal", "contains", "not_contains", "starts_with", "ends_with", "is_empty", "is_not_empty", "between", "not_between", "in", "not_in"]
        },
        "right": {
          "oneOf": [
            { "$ref": "#/definitions/ExpressionGroup" },
            { "type": "array", "items": { "$ref": "#/definitions/ExpressionGroup" } },
            { "type": "null" }
          ]
        }
      }
    }
  },

  "functions": {
    "MATH.ADD": {
      "label": "ADD",
      "returnType": "number",
      "description": "Adds multiple numbers together",
      "signature": {
        "dynamicArgs": {
          "type": "number",
          "minArgs": 2,
          "maxArgs": 10
        }
      },
      "ui": {
        "dynamicArgs": {
          "type": "number",
          "minArgs": 2,
          "maxArgs": 10,
          "defaultValue": 0,
          "valueSources": ["value", "field", "function"]
        }
      }
    },
    "MATH.SUBTRACT": {
      "label": "SUBTRACT",
      "returnType": "number",
      "description": "Subtracts second number from first number",
      "signature": {
        "args": {
          "num1": { "type": "number", "required": true },
          "num2": { "type": "number", "required": true }
        }
      },
      "ui": {
        "args": {
          "num1": {
            "label": "Number 1",
            "type": "number",
            "defaultValue": 0,
            "valueSources": ["value", "field", "function"]
          },
          "num2": {
            "label": "Number 2", 
            "type": "number",
            "defaultValue": 0,
            "valueSources": ["value", "field", "function"]
          }
        }
      }
    },
    "MATH.MULTIPLY": {
      "label": "MULTIPLY",
      "returnType": "number",
      "description": "Multiplies two numbers",
      "signature": {
        "args": {
          "num1": { "type": "number", "required": true },
          "num2": { "type": "number", "required": true }
        }
      },
      "ui": {
        "args": {
          "num1": {
            "label": "Number 1",
            "type": "number",
            "valueSources": ["value", "field", "function"]
          },
          "num2": {
            "label": "Number 2",
            "type": "number", 
            "valueSources": ["value", "field", "function"]
          }
        }
      }
    },
    "MATH.DIVIDE": {
      "label": "DIVIDE",
      "returnType": "number",
      "description": "Divides first number by second number",
      "signature": {
        "args": {
          "dividend": { "type": "number", "required": true },
          "divisor": { "type": "number", "required": true }
        }
      },
      "ui": {
        "args": {
          "dividend": {
            "label": "Dividend",
            "type": "number",
            "valueSources": ["value", "field", "function"]
          },
          "divisor": {
            "label": "Divisor",
            "type": "number",
            "valueSources": ["value", "field", "function"]
          }
        }
      }
    },
    "TEXT.CASE": {
      "label": "CASE",
      "returnType": "text",
      "description": "Converts text to specified case",
      "signature": {
        "args": {
          "text": { "type": "text", "required": true },
          "caseType": { "type": "text", "enum": ["UPPER", "LOWER", "TITLE"], "required": true }
        }
      },
      "ui": {
        "args": {
          "text": {
            "label": "Text",
            "type": "text",
            "valueSources": ["value", "field", "function"]
          },
          "caseType": {
            "label": "Case Type",
            "type": "text",
            "widget": "select",
            "defaultValue": "UPPER",
            "options": [
              { "value": "UPPER", "label": "Uppercase" },
              { "value": "LOWER", "label": "Lowercase" },
              { "value": "TITLE", "label": "Title Case" }
            ],
            "valueSources": ["value"]
          }
        }
      }
    },
    "DATE.DIFF": {
      "label": "DIFF",
      "returnType": "number",
      "description": "Calculates difference between two dates",
      "signature": {
        "args": {
          "units": { "type": "text", "enum": ["DAY", "MONTH", "YEAR"], "required": true },
          "date1": { "type": "date", "required": true },
          "date2": { "type": "date", "required": true }
        }
      },
      "ui": {
        "args": {
          "units": {
            "label": "Units",
            "type": "text",
            "widget": "select",
            "defaultValue": "DAY",
            "options": [
              { "value": "DAY", "label": "Day" },
              { "value": "MONTH", "label": "Month" },
              { "value": "YEAR", "label": "Year" }
            ],
            "valueSources": ["value"]
          },
          "date1": {
            "label": "Date 1",
            "type": "date",
            "valueSources": ["value", "field", "function", "ruleRef"]
          },
          "date2": {
            "label": "Date 2",
            "type": "date",
            "valueSources": ["value", "field", "function", "ruleRef"]
          }
        }
      }
    },
    "MATH.MAX": {
      "label": "MAX",
      "returnType": "number",
      "description": "Returns the maximum of multiple numbers",
      "signature": {
        "dynamicArgs": {
          "type": "number",
          "minArgs": 2,
          "maxArgs": 5
        }
      },
      "ui": {
        "dynamicArgs": {
          "type": "number",
          "minArgs": 2,
          "maxArgs": 5,
          "defaultValue": 0,
          "valueSources": ["value", "field", "function"]
        }
      }
    }
  },

  "operators": {
    "equal": { "label": "=", "cardinality": 1, "types": ["text", "number", "date", "boolean"] },
    "not_equal": { "label": "!=", "cardinality": 1, "types": ["text", "number", "date", "boolean"] },
    "less": { "label": "<", "cardinality": 1, "types": ["number", "date"] },
    "less_or_equal": { "label": "<=", "cardinality": 1, "types": ["number", "date"] },
    "greater": { "label": ">", "cardinality": 1, "types": ["number", "date"] },
    "greater_or_equal": { "label": ">=", "cardinality": 1, "types": ["number", "date"] },
    "contains": { "label": "Contains", "cardinality": 1, "types": ["text"] },
    "not_contains": { "label": "Not Contains", "cardinality": 1, "types": ["text"] },
    "starts_with": { "label": "Starts With", "cardinality": 1, "types": ["text"] },
    "ends_with": { "label": "Ends With", "cardinality": 1, "types": ["text"] },
    "is_empty": { "label": "Is Empty", "cardinality": 0, "types": ["text", "number", "date"] },
    "is_not_empty": { "label": "Is Not Empty", "cardinality": 0, "types": ["text", "number", "date"] },
    "between": { "label": "Between", "cardinality": 2, "separator": "AND", "types": ["number", "date"] },
    "not_between": { "label": "Not Between", "cardinality": 2, "separator": "AND", "types": ["number", "date"] },
    "in": { "label": "IN", "minCardinality": 1, "maxCardinality": 10, "defaultCardinality": 3, "separator": ",", "types": ["text", "number", "date"] },
    "not_in": { "label": "NOT IN", "minCardinality": 1, "maxCardinality": 10, "defaultCardinality": 3, "separator": ",", "types": ["text", "number", "date"] }
  },

  "fields": {
    "TABLE1.TEXT_FIELD_01": { "label": "Text Field 01", "type": "text" },
    "TABLE1.TEXT_FIELD_02": { "label": "Text Field 02", "type": "text" },
    "TABLE1.NUMBER_FIELD_01": { "label": "Number Field 01", "type": "number", "fieldSettings": { "min": 0 } },
    "TABLE1.NUMBER_FIELD_02": { "label": "Number Field 02", "type": "number", "fieldSettings": { "min": 0 } },
    "TABLE1.DATE_FIELD_01": { "label": "Date Field 01", "type": "date" },
    "TABLE1.DATE_FIELD_02": { "label": "Date Field 02", "type": "date" },
    "TABLE1.BOOLEAN_FIELD_01": { "label": "Boolean Field 01", "type": "boolean" },
    "TABLE1.BOOLEAN_FIELD_02": { "label": "Boolean Field 02", "type": "boolean" },
    "TABLE2.TEXT_FIELD_01": { "label": "Text Field 01", "type": "text" },
    "TABLE2.TEXT_FIELD_02": { "label": "Text Field 02", "type": "text" },
    "TABLE2.NUMBER_FIELD_01": { "label": "Number Field 01", "type": "number", "fieldSettings": { "min": 0 } },
    "TABLE2.NUMBER_FIELD_02": { "label": "Number Field 02", "type": "number", "fieldSettings": { "min": 0 } },
    "TABLE2.DATE_FIELD_01": { "label": "Date Field 01", "type": "date" },
    "TABLE2.DATE_FIELD_02": { "label": "Date Field 02", "type": "date" },
    "TABLE2.BOOLEAN_FIELD_01": { "label": "Boolean Field 01", "type": "boolean" },
    "TABLE2.BOOLEAN_FIELD_02": { "label": "Boolean Field 02", "type": "boolean" }
  },

  "ui": {
    "settings": {
      "valueLabel": "Value",
      "fieldLabel": "Field", 
      "operatorLabel": "Operator",
      "funcLabel": "Function",
      "addGroupLabel": "Add group",
      "addRuleLabel": "Add Condition",
      "notLabel": "NOT",
      "canReorder": true,
      "canRegroup": true,
      "showNot": true,
      "showLabels": true,
      "maxNesting": 5,
      "canLeaveEmptyGroup": true
    }
  }
}