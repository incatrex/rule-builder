# Rule Builder REST API Design

## **Core Principles**
- **RESTful** - Standard HTTP verbs and status codes
- **Consistent** - Uniform naming and patterns
- **Scalable** - Pagination for large datasets
- **Specific** - Clear, unambiguous naming

---

## **1. Rule Management**

### **Rule CRUD Operations**
```
# List rules with pagination/search
GET    /api/rules?page=1&size=20&search=customer&type=Validation&returnType=boolean

# Get specific rule (latest version)
GET    /api/rules/{uuid}

# Get specific rule version  
GET    /api/rules/{uuid}/versions/{version}

# Create new rule (server generates UUID)
POST   /api/rules

# Update rule (creates new version, preserves UUID)
PUT    /api/rules/{uuid}

# Delete rule (all versions)
DELETE /api/rules/{uuid}
```

### **Rule Versions & History**
```
# Get all versions of a rule
GET    /api/rules/{uuid}/versions

# Get rule history with metadata
GET    /api/rules/{uuid}/history

# Restore specific version (creates new version)
POST   /api/rules/{uuid}/restore/{version}
```

### **Rule Operations**
```
# Validate rule structure
POST   /api/rules/validate

# Convert rule to SQL
POST   /api/rules/{uuid}/versions/{version}/sql
POST   /api/rules/{uuid}/sql  # Latest version
```

---

## **2. UUID Management & Versioning**

### **Server-Side UUID Generation**
- **UUIDs are generated by the server** during rule creation
- **Client never provides UUID** in create requests
- **Server injects UUID** into the rule JSON before saving
- **UUID remains constant** across all versions of a rule
- **Version numbers** start at 1 and increment with each update

### **Rule Creation Flow**
```
1. Client sends rule without UUID/version
2. Server generates UUID (v4)
3. Server sets version = 1
4. Server injects UUID and version into rule JSON
5. Server saves rule with generated UUID
6. Server returns UUID and complete rule to client
```

### **Rule Update Flow**  
```
1. Client sends updated rule without UUID/version
2. Server finds current max version for UUID
3. Server increments version number
4. Server injects existing UUID and new version into rule JSON
5. Server saves new version
6. Server returns UUID, new version, and complete rule
```

---

## **3. Configuration Management**

### **RuleBuilder Configuration**
```
# Get RuleBuilder configuration (functions, operators, etc.)
GET    /api/rulebuilder/config

# Get specific config section
GET    /api/rulebuilder/config/functions
GET    /api/rulebuilder/config/operators
GET    /api/rulebuilder/config/types
```

### **Field Management (Paginated)**
```
# Search fields with pagination
GET    /api/fields?page=1&size=20&search=customer&type=text&table=TABLE1

# Get specific field details
GET    /api/fields/{fieldId}

# Get field schema/metadata
GET    /api/fields/schema
```

---

## **4. Request/Response Examples**

### **POST /api/rules (Create New Rule)**
```json
// Request - No UUID or version provided
{
  "structure": "expression",
  "returnType": "boolean",
  "ruleType": "Validation",
  "metadata": {
    "id": "customer-age-validation",
    "description": "Validates customer age requirements"
  },
  "definition": {
    "type": "condition",
    "name": "Age Check",
    "left": { /* expression group */ },
    "operator": "greater_or_equal", 
    "right": { /* expression group */ }
  }
}

// Response - Server generates UUID and sets version
{
  "uuid": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "version": 1,
  "ruleId": "customer-age-validation",
  "rule": {
    "uuid": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
    "version": 1,
    "structure": "expression",
    "returnType": "boolean",
    "ruleType": "Validation", 
    "metadata": { /* same as request */ },
    "definition": { /* same as request */ }
  },
  "message": "Rule created successfully",
  "createdAt": "2025-11-14T15:30:00Z"
}
```

### **PUT /api/rules/{uuid} (Update Rule)**
```json
// Request - No UUID or version provided (server handles)
{
  "structure": "expression",
  "returnType": "boolean", 
  "ruleType": "Validation",
  "metadata": {
    "id": "customer-age-validation",
    "description": "Updated: Validates customer age requirements with new logic"
  },
  "definition": {
    /* updated rule content */
  }
}

// Response - Server preserves UUID, increments version
{
  "uuid": "a1b2c3d4-e5f6-7890-abcd-ef1234567890", 
  "version": 2,
  "ruleId": "customer-age-validation",
  "rule": {
    "uuid": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
    "version": 2,
    "structure": "expression",
    /* updated fields from request */
  },
  "message": "Rule updated successfully",
  "updatedAt": "2025-11-14T16:45:00Z"
}
```

### **GET /api/rules (Paginated)**
```json
// Request
GET /api/rules?page=1&size=20&search=customer&type=Validation

// Response
{
  "data": [
    {
      "uuid": "12345678-1234-1234-1234-123456789abc",
      "ruleId": "customer-validation-rule",
      "name": "Customer Age Validation",
      "description": "Validates customer age requirements",
      "ruleType": "Validation",
      "returnType": "boolean",
      "latestVersion": 3,
      "createdAt": "2025-11-14T10:00:00Z",
      "updatedAt": "2025-11-14T14:30:00Z",
      "createdBy": "user123"
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "total": 150,
    "totalPages": 8
  },
  "filters": {
    "search": "customer",
    "type": "Validation",
    "returnType": null
  }
}
```

### **GET /api/fields (Paginated)**
```json
// Request  
GET /api/fields?page=1&size=20&search=customer&type=text

// Response
{
  "data": [
    {
      "id": "TABLE1.CUSTOMER_NAME",
      "label": "Customer Name",
      "type": "text",
      "table": "TABLE1",
      "description": "Full name of the customer",
      "required": true,
      "fieldSettings": {
        "maxLength": 100,
        "pattern": "^[A-Za-z\\s]+$"
      }
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "total": 1250,
    "totalPages": 63
  },
  "filters": {
    "search": "customer",
    "type": "text",
    "table": null
  }
}
```

### **GET /api/rulebuilder/config**
```json
{
  "functions": {
    "MATH.ADD": {
      "label": "ADD",
      "returnType": "number",
      "description": "Adds multiple numbers together",
      "signature": { ... },
      "ui": { ... }
    }
  },
  "operators": {
    "equal": {
      "label": "=",
      "cardinality": 1,
      "types": ["text", "number", "date", "boolean"]
    }
  },
  "types": {
    "ruleTypes": ["Reporting", "Transformation", "Aggregation", "Validation"],
    "returnTypes": ["boolean", "number", "text", "date"],
    "fieldTypes": ["boolean", "number", "text", "date"]
  },
  "settings": {
    "maxNesting": 5,
    "canReorder": true,
    "showLabels": true
  }
}
```

---

## **5. Query Parameters (Standard)**

### **Pagination**
```
?page=1           # Page number (1-based)
&size=20          # Items per page (default: 20, max: 100)
```

### **Search & Filtering**
```
?search=customer  # Text search across name/description
&type=Validation  # Filter by ruleType
&returnType=boolean # Filter by returnType
&table=TABLE1     # Filter by table (for fields)
&createdBy=user123 # Filter by creator
```

### **Sorting**
```
&sort=name,asc    # Sort by field, direction
&sort=updatedAt,desc # Multiple sorts supported
```

---

## **6. HTTP Status Codes**

```
200 OK           # Successful GET/PUT
201 Created      # Successful POST
204 No Content   # Successful DELETE
400 Bad Request  # Invalid request data
404 Not Found    # Resource not found
409 Conflict     # Version conflict
422 Unprocessable Entity # Validation errors
500 Internal Server Error # Server error
```

---

## **7. Error Response Format**

```json
{
  "error": {
    "code": "VALIDATION_FAILED",
    "message": "Rule validation failed",
    "details": [
      {
        "field": "content.expressions[0].function.args[0].name",
        "message": "Expected 'units' but found 'units1'",
        "code": "INVALID_ARGUMENT_NAME"
      }
    ],
    "timestamp": "2025-11-14T14:30:00Z",
    "path": "/api/rules/validate"
  }
}
```

---

## **8. Migration Strategy**

### **Phase 1: Add New Endpoints (Backward Compatible)**
- Keep existing endpoints working
- Add new standardized endpoints
- Update frontend services to use new endpoints

### **Phase 2: Deprecate Old Endpoints**
- Mark old endpoints as deprecated
- Add deprecation headers
- Update documentation

### **Phase 3: Remove Old Endpoints**
- Remove deprecated endpoints
- Clean up backend code

---

## **9. Frontend Service Organization**

```javascript
// HttpHelper.js
class HttpHelper {
  constructor(baseURL = '/api') { ... }
  get(url, params) { ... }
  post(url, data) { ... }
  // Handle pagination, errors, etc.
}

// RuleService.js
class RuleService {
  async getRules(pagination, filters) { ... }
  async getRule(uuid) { ... }
  async getRuleVersion(uuid, version) { ... }
  async createRule(rule) { ... }
  async updateRule(uuid, rule) { ... }
  async deleteRule(uuid) { ... }
  async validateRule(rule) { ... }
  async getRuleVersions(uuid) { ... }
  async restoreVersion(uuid, version) { ... }
  async convertToSql(uuid, version) { ... }
}

// ConfigService.js
class ConfigService {
  async getRuleBuilderConfig() { ... }
  async getFunctions() { ... }
  async getOperators() { ... }
  async getTypes() { ... }
}

// FieldService.js
class FieldService {
  async getFields(pagination, filters) { ... }
  async getField(fieldId) { ... }
  async getFieldSchema() { ... }
}
```

Would you like me to proceed with implementing this API design?